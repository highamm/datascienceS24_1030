---
title: "Section 16: Database Intro"
author: "Matt Higham"
format: 
  html:
    embed-resources: true
---

```{r}
library(RSQLite)
library(DBI) 
library(dplyr)
library(dbplyr)

imdb_db <- dbConnect(RSQLite::SQLite(), 
                     dbname = here::here("data/imdb_tv.sqlite"))

dbListTables(conn = imdb_db)

library(tidyverse)

sql <- "
  SELECT parentTconst, averageRating, numVotes
  FROM show_ratings 
  WHERE numVotes > 100000
"

dbGetQuery(imdb_db, sql) |>
  as_tibble()
```

Exercise 1. From the show_ratings data frame (table), it is only keeping shows where the number of votes are larger than 100,000. And then it's only keeping three of the original variables (fields).

Exercise 2. WHERE is like `filter()` and SELECT is like `select()`


## Section 16.2

```{r}
library(dbplyr)
episode_rating_tbl <- tbl(imdb_db, "episode_rating")
episode_rating_tbl
```

```{r}
episode_query1 <- episode_rating_tbl |> 
  filter(averageRating > 9.0) |> 
  select(parentTconst, Episode_Name, numVotes, averageRating)
episode_query1
#> # Source:   SQL [?? x 4]
#> # Database: sqlite 3.50.3 [/Users/highamm/git_repos/courses/ds234_quarto/data/imdb_tv.sqlite]
#>   parentTconst Episode_Name          numVotes averageRating
#>   <chr>        <chr>                    <dbl>         <dbl>
#> 1 tt7221388    December 19               6245           9.4
#> 2 tt5753856    Die Reisenden            13000           9.4
#> 3 tt5753856    Vom Suchen und Finden    11905           9.2
#> 4 tt5753856    Ein unendlicher kreis    14775           9.5
#> 5 tt5753856    Der weiße Teufel         11809           9.1
#> 6 tt5753856    Enden und Anfänge        14651           9.4
#> # ℹ more rows

## collect() converts this back to our standard "tibble" which
## now behaves exactly like everything we've seen in this course.
episode_query1 |>
  collect()

episode_query1 |>
  show_query()

```

```{r}
mean_query1 <- episode_rating_tbl |>
  group_by(parentTconst) |>
  summarise(mean_rating = mean(averageRating)) |>
  arrange(desc(mean_rating))
mean_query1

mean_query1 |> show_query()
## GROUP BY is like group_by()
## ORDER BY with DESC at the end is like arranage(desc(xxxxx))
## SELECT AVG(`averageRating`) AS `mean_rating` is like summarise(mean_rating = mean(averageRating))


```

Exercise 3.

```{r}
count_query <- episode_rating_tbl |>
  group_by(parentTconst) |>
  summarise(n_episodes = n())
count_query |> show_query()
```

Section 16.3: SQL

```{r}
episode_rating_tbl |> filter(seasonNumber == 1) |>
  arrange(desc(numVotes)) |>
  show_query()
```

SELECT -> select(), rename(), mutate(), summarise()
for rename(), mutate(), and summarise(), the name of the new variable goes after AS

GROUP BY -> group_by()

WHERE -> filter()

ORDER BY -> arrange()

FROM -> which data frame are you working with?

```{r}
show_info_tbl <- tbl(imdb_db, "show_info")

left_join(episode_rating_tbl, show_info_tbl,
          join_by(parentTconst == parentTconst)) |>
  show_query()
```

Exercise 4.

```{r}
show_info_tbl |> filter(Show_Name == "Ozark") |>
  show_query()
```

Class Exercise 1.

```{r}
show_info_tbl |> rename(show_name = Show_Name) |>
  arrange(desc(startYear)) |>
  show_query()
```

Your Turns 1 through 4.

Your Turn 1.

SELECT "parentTconst", MAX("averageRating") AS "best_episode"
FROM "episode_rating_tbl"
GROUP BY "parentTconst"

```{r}
episode_rating_tbl |> group_by(parentTconst) |>
  summarise(best_episode = max(averageRating)) |>
  show_query()
```

Your Turn 2.

```{r}
episode_rating_tbl |>
  mutate(test = fct_recode(seasonNumber,
                           "season 1" = "1"))
## SQL cannot do forcats, lubridate, and many other wrangling packages
```

Your Turn 3.

```{r}
episode_rating_tbl |> filter(seasonNumber != "1") |>
  show_query()
## SAME
episode_rating_tbl |>
  filter(seasonNumber %in% c("1", "2")) |>
  show_query()
## IN

episode_rating_tbl |> distinct(parentTconst) |>
  show_query()
## DISTINCT
```

Your Turn 4.
<SQL>
SELECT "parentTconst", COUNT(*) AS "n_episodes"
FROM "episode_rating_tbl"
WHERE ("seasonNumber" = '1')
GROUP BY "parentTconst"
ORDER BY "n_episodes" DESC

```{r}
episode_rating_tbl  |>
  group_by(parentTconst) |> 
  filter(seasonNumber == "1") |>
  summarise(n_episodes = n()) |>
  arrange(desc(n_episodes)) |>
  show_query()
  
```



